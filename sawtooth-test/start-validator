# keys are under /etc/sawtooth/keys, /root/.sawtooth/keys
# block, genesis, merkle, receipts are under /var/lib/sawtooth/

pid=$(ps aux | grep pypy3 | grep -v grep | awk '{print $2}')
if [[ ! -z $pid ]];then
  kill $pid
  # clear the existing chain then restart
  rm -rf /var/lib/sawtooth/*
elif [[ $1 != 'restart' ]];then
  # create from scratch if not restart
  pypy3 bin/sawadm keygen --force 
  pypy3 bin/sawtooth keygen my_key --force 
  pypy3 bin/sawset genesis -k /root/.sawtooth/keys/my_key.priv -o /root/.sawtooth/config-genesis.batch 
  pypy3 bin/sawset proposal create -k /root/.sawtooth/keys/my_key.priv sawtooth.publisher.max_batches_per_block=1000 -o /root/.sawtooth/poet-settings.batch 
else
  # just restart
  rm -rf /var/lib/sawtooth/*
fi


# rm -rf /var/lib/sawtooth/*
pypy3 bin/sawadm genesis /root/.sawtooth/config-genesis.batch /root/.sawtooth/poet-settings.batch
# finally run validator
pypy3 bin/sawtooth-validator -vv --scheduler parallel --endpoint tcp://validator:8800 --bind component:tcp://eth0:4004 --bind network:tcp://eth0:8800